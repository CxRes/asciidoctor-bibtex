#!/usr/bin/env ruby

# Executable for asciidoc-bib
#
# Provides some command line options for adding reference material 
# to asciidoc files, generating revised files for processing by 
# asciidoc.
#
# Copyright (c) Peter Lane, 2012-13.
# Released under Open Works License, 0.9.2

require 'asciidoc-bib'
require 'optparse'

include AsciidocBib

VERSION = "1.5.0"

bibfile = ""
links = true
style = Styles.first

options = OptionParser.new do |opts|
  opts.banner = "Usage: asciidoc-bib filename"
  opts.on("-h", "--help", "help message") do |v|
    puts "asciidoc-bib #{VERSION}"
    puts
    puts options
    puts
    puts "Supported styles:"
    puts "-- builtin"
    print "   "
    puts BuiltinStyles.join("\n   ")
    puts "-- citeproc"
    print "   "
    puts CiteProcStyles.join("\n   ")
    exit!
  end
  opts.on("-b", "--bibfile FILE", "location of bib file") do |v|
    bibfile = v
  end
	opts.on("-n", "--no-links", "do not add internal links") do |v|
		links = false
	end
	opts.on("-s", "--style STYLE", "reference style") do |v|
		style = v
	end
	opts.on("-v", "--version", "show version") do |v|
		puts "asciidoc-bib version #{VERSION}"
    exit!
	end
end

begin
  options.parse!
rescue
  puts options
  exit!
end

if bibfile.empty?
  bibfile = find_bibliography "."
  if bibfile.empty?
    bibfile = find_bibliography "#{ENV['HOME']}/Documents"
  end
end
if bibfile.empty?
  puts "Error: could not find a bibliography file"
  exit
end
unless Styles.include?(style)
	puts "Error: style must be one of #{Styles.join(", ")}"
	exit
end
unless ARGV.length == 1
	puts "Error: a single file to convert must be given"
	exit
end

puts "Reading biblio: #{bibfile}"
puts "Reference style: #{style}"

biblio = read_bibliography bibfile

cites_used = read_citations ARGV[0]
puts "Cites: #{cites_used.join(",")}"

add_citations(ARGV[0], cites_used, biblio, links, style)

